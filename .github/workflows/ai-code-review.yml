name: Code Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Setup Review Tool
        run: |
          npm install -g typescript tsx
          npm install @anthropic-ai/sdk glob dotenv express cors
          git clone https://github.com/your-org/AI-CodeReview-Assistant.git review-tool
          cd review-tool && npm install
      
      - name: Start Review Server
        run: |
          cd review-tool
          npm run server &
          sleep 10
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Run Quality Gate
        id: review
        run: |
          cd review-tool
          git diff --name-only origin/${{ github.base_ref }}...HEAD | \
            grep -E '\.(py|scala|sql|tf)$' | \
            xargs npx tsx scripts/ci-review.ts \
              --threshold 75 \
              --fail-on-critical \
              --format json \
              --output ../review-results.json
        env:
          CODE_REVIEW_API_URL: http://localhost:5001/api
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      
      - name: Comment Results on PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('review-results.json', 'utf8'));
            const summary = results.summary;
            
            const status = summary.passThreshold ? '‚úÖ PASSED' : '‚ùå FAILED';
            const comment = `## Code Quality Review ${status}
            
            **Score:** ${summary.averageScore}/100
            **Threshold:** 75/100
            
            ### Issues Found
            - üî¥ Critical: ${summary.criticalCount}
            - üü† High: ${summary.highCount}
            - üü° Medium: ${summary.mediumCount}
            - üü¢ Low: ${summary.lowCount}
            
            ${summary.passThreshold ? '‚úÖ Quality gate passed! Ready to merge.' : '‚ùå Quality gate failed. Please address the issues above.'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# Then in your main workflow, keep it simple:
# .github/workflows/main.yml
name: CI/CD
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy
        run: ./deploy.sh

# Enable branch protection:
# Settings ‚Üí Branches ‚Üí Add rule for 'main'
# ‚úì Require status checks: "Code Quality Gate / quality-check"